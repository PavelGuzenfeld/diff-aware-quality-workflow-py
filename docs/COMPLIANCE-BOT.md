# Compliance Bot — Integration & Operations Guide

## What It Does

The compliance bot keeps consumer repos in sync with `standard` releases:

1. **Scans** all repos in a GitHub org for `.standard.yml`
2. **Detects drift** — which repos are pinned to an old SHA
3. **Opens PRs** automatically to update SHA pins when a new `standard` release is published
4. **Generates dashboards** showing org-wide compliance status

## Architecture

```
New standard release (e.g. v0.18.1)
       |
  run-compliance-bot.yml triggers
       |
  ┌────┴──────────────────────────────────┐
  │  1. pip install standard-ci           │
  │  2. standard-ci scan --org ORG        │
  │     → finds repos with .standard.yml  │
  │     → checks SHA pins vs latest       │
  │  3. standard-ci auto-update --org ORG │
  │     → clones drifted repos            │
  │     → updates SHA pins                │
  │     → opens PRs via gh CLI            │
  └───────────────────────────────────────┘
```

## Setup (One-Time)

### 1. Set the bot token

The bot needs a GitHub token with `repo` and `workflow` scopes to push branches
and create PRs in consumer repos.

```bash
# Use your gh CLI token (has repo + workflow scopes)
gh auth token | gh secret set COMPLIANCE_BOT_TOKEN --repo PavelGuzenfeld/standard
```

Or create a fine-grained PAT at https://github.com/settings/tokens with:
- **Repository access**: All repos in target orgs
- **Permissions**: Contents (Read & Write), Pull Requests (Read & Write), Workflows (Read & Write)

### 2. Trigger workflows are already configured

These files live in `PavelGuzenfeld/standard`:

| File | Trigger | What it does |
|------|---------|-------------|
| `.github/workflows/run-compliance-bot.yml` | On every release + manual | Scans orgs, opens update PRs |
| `.github/workflows/run-compliance-dashboard.yml` | Weekly Monday 9am UTC + manual | Generates compliance report |

Currently configured orgs: `PavelGuzenfeld`, `thebandofficial`

#### Adding a new org

Edit `run-compliance-bot.yml` and `run-compliance-dashboard.yml` to add a new job block:

```yaml
  update-my-org:
    if: github.event_name == 'release'
    uses: ./.github/workflows/compliance-bot.yml
    with:
      org: my-org-name
    secrets:
      bot_token: ${{ secrets.COMPLIANCE_BOT_TOKEN }}
```

## Onboarding a Consumer Repo

A consumer repo needs two things:

### 1. Workflow files calling `standard`

Example `.github/workflows/standards.yml`:

```yaml
jobs:
  cpp-quality:
    uses: PavelGuzenfeld/standard/.github/workflows/cpp-quality.yml@<SHA>  # v0.18.1
    with:
      docker_image: ghcr.io/my-org/my-image:latest
      # ... other inputs
```

### 2. A `.standard.yml` file in the repo root

This is what the compliance bot looks for. It records which tag/SHA the repo is pinned to:

```yaml
# Generated by standard-ci — do not edit manually

version: 0.17.0
preset: full
tag: v0.18.1
sha: 43db1db5f75c953fbd514914205757eedcfa72ce
workflows:
  - cpp-quality
  - infra-lint
  - python-quality
```

#### Quick onboard with CLI

```bash
cd /path/to/consumer-repo
pip install standard-ci   # or: pip install git+https://github.com/PavelGuzenfeld/standard.git
standard-ci init --preset recommended
# Creates .github/workflows/*.yml + .standard.yml
git add . && git commit -m "chore: onboard standard-ci" && git push
```

#### Manual onboard (existing workflow)

If the repo already has `standards.yml` calling standard workflows, just add `.standard.yml`:

```yaml
tag: v0.18.1
sha: 43db1db5f75c953fbd514914205757eedcfa72ce
workflows:
  - cpp-quality
  - infra-lint
```

## Operations

### Where is the dashboard?

**Option A: GitHub Actions → workflow run summary**

1. Go to https://github.com/PavelGuzenfeld/standard/actions/workflows/run-compliance-dashboard.yml
2. Click the latest run
3. The dashboard is in the **Summary** tab (step summary)

**Option B: Download artifact**

Each dashboard run uploads a `compliance-dashboard` artifact (markdown file).

**Option C: Run locally**

```bash
export GITHUB_TOKEN=ghp_...
standard-ci dashboard --org PavelGuzenfeld
standard-ci dashboard --org thebandofficial
standard-ci dashboard --org thebandofficial --format json
```

### How to trigger manually

#### Trigger the compliance bot (scan + open PRs)

**From GitHub UI:**

1. Go to https://github.com/PavelGuzenfeld/standard/actions/workflows/run-compliance-bot.yml
2. Click **"Run workflow"** (top right)
3. Enter the org name (default: `PavelGuzenfeld`)
4. Optionally check "Dry run" to preview without opening PRs
5. Click **"Run workflow"**

**From CLI:**

```bash
# Scan and open PRs for an org
gh workflow run run-compliance-bot.yml \
  --repo PavelGuzenfeld/standard \
  -f org=thebandofficial \
  -f dry_run=false

# Dry run (just see what would happen)
gh workflow run run-compliance-bot.yml \
  --repo PavelGuzenfeld/standard \
  -f org=thebandofficial \
  -f dry_run=true
```

#### Trigger the dashboard

**From GitHub UI:**

1. Go to https://github.com/PavelGuzenfeld/standard/actions/workflows/run-compliance-dashboard.yml
2. Click **"Run workflow"**
3. Enter the org name
4. Click **"Run workflow"**

**From CLI:**

```bash
gh workflow run run-compliance-dashboard.yml \
  --repo PavelGuzenfeld/standard \
  -f org=thebandofficial
```

### Scan without opening PRs (CLI only)

```bash
export GITHUB_TOKEN=ghp_...

# Quick scan — see which repos are current/drifted/unconfigured
standard-ci scan --org thebandofficial

# JSON output (for scripting)
standard-ci scan --org thebandofficial --json

# Exit non-zero if any repo is drifted (useful in CI)
standard-ci scan --org thebandofficial --exit-code
```

### Auto-update PRs (CLI only)

```bash
export GITHUB_TOKEN=ghp_...

# Dry run — see what PRs would be opened
standard-ci auto-update --org thebandofficial --dry-run

# Actually open PRs
standard-ci auto-update --org thebandofficial
```

## What happens automatically

| Event | Action |
|-------|--------|
| New `standard` release published | Bot scans `PavelGuzenfeld` + `thebandofficial`, opens PRs in drifted repos |
| Every Monday 9am UTC | Dashboard generated for both orgs (visible in Actions summary) |
| PR opened by bot in consumer repo | Team reviews and merges the SHA pin update |

## Troubleshooting

| Problem | Solution |
|---------|----------|
| Bot can't push to consumer repo | Check `COMPLIANCE_BOT_TOKEN` has `repo` + `workflow` scopes |
| Bot doesn't detect a repo | Add `.standard.yml` to the repo root |
| Dashboard shows "0 repos scanned" | Token may lack `read:org` scope for private orgs |
| PR has merge conflicts | The bot creates a simple branch; resolve conflicts and merge manually |
| Want to skip a repo | Don't add `.standard.yml` — unconfigured repos are listed but not updated |

## CLI Reference

```
standard-ci scan --org ORG [--token TOKEN] [--json] [--exit-code]
standard-ci dashboard --org ORG [--token TOKEN] [--format markdown|json] [--scan-results FILE]
standard-ci auto-update --org ORG [--token TOKEN] [--dry-run] [--scan-results FILE]
                        [--pr-title-prefix PREFIX] [--pr-labels LABELS]
```
