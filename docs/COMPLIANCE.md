# Compliance — Integration & Operations Guide

## What It Does

The compliance workflow keeps consumer repos in sync with `standard` releases:

1. **Scans** all repos in a GitHub org for `.standard.yml`
2. **Detects drift** — which repos are pinned to an old SHA
3. **Generates a dashboard** showing org-wide compliance status
4. **Opens PRs** (optional) to update SHA pins in drifted repos

## Architecture

```
PavelGuzenfeld/standard (source of truth)
  └── .github/workflows/
        └── compliance.yml  ← reusable workflow (the engine)

Each org's .github repo (trigger)
  └── .github/workflows/
        └── compliance.yml  ← calls standard's reusable workflow
```

Every run: scan + dashboard. With `auto_update: true`: also opens PRs.

```
  ┌───────────────────────────────────────┐
  │  1. Checkout PavelGuzenfeld/standard  │
  │  2. pip install standard-ci           │
  │  3. standard-ci scan --org ORG        │
  │     → finds repos with .standard.yml  │
  │     → checks SHA pins vs latest       │
  │  4. Generate dashboard (always)       │
  │  5. standard-ci auto-update --org ORG │
  │     → only if auto_update is true     │
  │     → clones drifted repos            │
  │     → updates SHA pins                │
  │     → opens PRs via gh CLI            │
  └───────────────────────────────────────┘
```

## Setup (One-Time per Org)

### 1. Set the bot token

The bot needs a GitHub token with `repo` and `workflow` scopes to push branches
and create PRs in consumer repos.

```bash
# Set the secret in the org's .github repo
gh auth token | gh secret set COMPLIANCE_BOT_TOKEN --repo MY-ORG/.github
```

Or create a fine-grained PAT at https://github.com/settings/tokens with:
- **Repository access**: All repos in target org
- **Permissions**: Contents (Read & Write), Pull Requests (Read & Write), Workflows (Read & Write)

### 2. Add a trigger workflow to the org's `.github` repo

Create `.github/workflows/compliance.yml`:

```yaml
name: Compliance

on:
  schedule:
    - cron: '0 9 * * 1'  # Monday 9am UTC
  workflow_dispatch:
    inputs:
      auto_update:
        description: 'Open PRs to update drifted repos'
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (no PRs opened)'
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  compliance:
    uses: PavelGuzenfeld/standard/.github/workflows/compliance.yml@main
    with:
      org: MY-ORG
      auto_update: ${{ inputs.auto_update || false }}
      dry_run: ${{ inputs.dry_run || false }}
    secrets:
      bot_token: ${{ secrets.COMPLIANCE_BOT_TOKEN }}
```

### Currently configured orgs

| Org | Trigger repo | Status |
|-----|-------------|--------|
| `PavelGuzenfeld` | `PavelGuzenfeld/.github` | Active |
| `thebandofficial` | `thebandofficial/.github` | Active |

## Onboarding a Consumer Repo

A consumer repo needs two things:

### 1. Workflow files calling `standard`

Example `.github/workflows/standards.yml`:

```yaml
jobs:
  cpp-quality:
    uses: PavelGuzenfeld/standard/.github/workflows/cpp-quality.yml@<SHA>  # v0.18.1
    with:
      docker_image: ghcr.io/my-org/my-image:latest
      # ... other inputs
```

### 2. A `.standard.yml` file in the repo root

This is what the compliance bot looks for. It records which tag/SHA the repo is pinned to:

```yaml
# Generated by standard-ci — do not edit manually

version: 0.17.0
preset: full
tag: v0.18.1
sha: 43db1db5f75c953fbd514914205757eedcfa72ce
workflows:
  - cpp-quality
  - infra-lint
  - python-quality
```

#### Quick onboard with CLI

```bash
cd /path/to/consumer-repo
pip install standard-ci   # or: pip install git+https://github.com/PavelGuzenfeld/standard.git
standard-ci init --preset recommended
# Creates .github/workflows/*.yml + .standard.yml
git add . && git commit -m "chore: onboard standard-ci" && git push
```

#### Manual onboard (existing workflow)

If the repo already has `standards.yml` calling standard workflows, just add `.standard.yml`:

```yaml
tag: v0.18.1
sha: 43db1db5f75c953fbd514914205757eedcfa72ce
workflows:
  - cpp-quality
  - infra-lint
```

## Operations

### Where is the dashboard?

**Option A: GitHub Actions → workflow run summary**

Go to the Actions tab of the org's `.github` repo and click the latest "Compliance" run:
- PavelGuzenfeld: https://github.com/PavelGuzenfeld/.github/actions/workflows/compliance.yml
- thebandofficial: https://github.com/thebandofficial/.github/actions/workflows/compliance.yml

The dashboard is in the **Summary** tab (step summary).

**Option B: Download artifact**

Each run uploads a `compliance-dashboard` artifact (markdown file).

**Option C: Run locally**

```bash
export GITHUB_TOKEN=ghp_...
standard-ci dashboard --org PavelGuzenfeld
standard-ci dashboard --org thebandofficial
standard-ci dashboard --org thebandofficial --format json
```

### How to trigger manually

Each org's workflow is triggered from that org's `.github` repo, not from `standard`.

**From GitHub UI:**

1. Go to `https://github.com/MY-ORG/.github/actions/workflows/compliance.yml`
2. Click **"Run workflow"** (top right)
3. Check "auto_update" to also open PRs in drifted repos
4. Check "dry_run" to preview without opening PRs
5. Click **"Run workflow"**

**From CLI:**

```bash
# Dashboard only (default)
gh workflow run compliance.yml --repo PavelGuzenfeld/.github

# Dashboard + open update PRs
gh workflow run compliance.yml --repo thebandofficial/.github \
  -f auto_update=true

# Dashboard + dry run (preview PRs)
gh workflow run compliance.yml --repo thebandofficial/.github \
  -f auto_update=true -f dry_run=true
```

### Scan without opening PRs (CLI only)

```bash
export GITHUB_TOKEN=ghp_...

# Quick scan — see which repos are current/drifted/unconfigured
standard-ci scan --org thebandofficial

# JSON output (for scripting)
standard-ci scan --org thebandofficial --json

# Exit non-zero if any repo is drifted (useful in CI)
standard-ci scan --org thebandofficial --exit-code
```

### Auto-update PRs (CLI only)

```bash
export GITHUB_TOKEN=ghp_...

# Dry run — see what PRs would be opened
standard-ci auto-update --org thebandofficial --dry-run

# Actually open PRs
standard-ci auto-update --org thebandofficial
```

## What happens automatically

| Event | Action |
|-------|--------|
| Every Monday 9am UTC | Compliance workflow runs per org — dashboard generated (visible in that org's `.github` Actions summary) |
| PR opened by bot in consumer repo | Team reviews and merges the SHA pin update |

To also auto-update on schedule, set `auto_update: true` in the trigger workflow's `with:` block.

## Troubleshooting

| Problem | Solution |
|---------|----------|
| Bot can't push to consumer repo | Check `COMPLIANCE_BOT_TOKEN` in the org's `.github` repo has `repo` + `workflow` scopes |
| Bot doesn't detect a repo | Add `.standard.yml` to the repo root |
| Dashboard shows "0 repos scanned" | Token may lack `read:org` scope for private orgs |
| PR has merge conflicts | The bot creates a simple branch; resolve conflicts and merge manually |
| Want to skip a repo | Don't add `.standard.yml` — unconfigured repos are listed but not updated |
| Workflow fails at "Install standard-ci" | Reusable workflow needs `repository: PavelGuzenfeld/standard` in checkout step |

## CLI Reference

```
standard-ci scan --org ORG [--token TOKEN] [--json] [--exit-code]
standard-ci dashboard --org ORG [--token TOKEN] [--format markdown|json] [--scan-results FILE]
standard-ci auto-update --org ORG [--token TOKEN] [--dry-run] [--scan-results FILE]
                        [--pr-title-prefix PREFIX] [--pr-labels LABELS]
```
