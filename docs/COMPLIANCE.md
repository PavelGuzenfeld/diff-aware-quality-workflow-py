# Compliance — Integration & Operations Guide

## What It Does

The compliance workflow keeps consumer repos in sync with `standard` releases:

1. **Scans** all repos in a GitHub org for `.standard.yml`
2. **Detects drift** — which repos are pinned to an old SHA
3. **Generates a dashboard** showing org-wide compliance status
4. **Opens PRs** (optional) to update SHA pins in drifted repos

## Architecture

```
PavelGuzenfeld/standard (source of truth)
  └── .github/workflows/
        └── compliance.yml  ← reusable workflow (the engine)

Each org's .github repo (trigger)
  └── .github/workflows/
        └── compliance.yml  ← calls standard's reusable workflow
```

Every run: scan + dashboard. With `auto_update: true`: also opens PRs.

```
  ┌───────────────────────────────────────┐
  │  1. Checkout PavelGuzenfeld/standard  │
  │  2. pip install standard-ci           │
  │  3. standard-ci scan --org ORG        │
  │     → finds repos with .standard.yml  │
  │     → checks SHA pins vs latest       │
  │  4. Generate dashboard (always)       │
  │  5. standard-ci auto-update --org ORG │
  │     → only if auto_update is true     │
  │     → clones drifted repos            │
  │     → updates SHA pins                │
  │     → opens PRs via gh CLI            │
  └───────────────────────────────────────┘
```

## Setup (One-Time per Org)

### 1. Set the bot token

The bot needs a GitHub token with `repo` and `workflow` scopes to push branches
and create PRs in consumer repos.

```bash
# Set the secret in the org's .github repo
gh auth token | gh secret set COMPLIANCE_BOT_TOKEN --repo my-org/.github
```

Or create a fine-grained PAT at https://github.com/settings/tokens with:
- **Repository access**: All repos in target org
- **Permissions**: Contents (Read & Write), Pull Requests (Read & Write), Workflows (Read & Write)

### 2. Add a trigger workflow to the org's `.github` repo

Create `.github/workflows/compliance.yml`:

```yaml
name: Compliance

on:
  schedule:
    - cron: '0 9 * * 1'  # Monday 9am UTC
  workflow_dispatch:
    inputs:
      auto_update:
        description: 'Open PRs to update drifted repos'
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (no PRs opened)'
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  compliance:
    uses: PavelGuzenfeld/standard/.github/workflows/compliance.yml@main
    with:
      org: my-org
      auto_update: ${{ inputs.auto_update || false }}
      dry_run: ${{ inputs.dry_run || false }}
    secrets:
      bot_token: ${{ secrets.COMPLIANCE_BOT_TOKEN }}
```

## Onboarding a Consumer Repo

A consumer repo needs two things:

### 1. Workflow files calling `standard`

Example `.github/workflows/standards.yml`:

```yaml
jobs:
  cpp-quality:
    uses: PavelGuzenfeld/standard/.github/workflows/cpp-quality.yml@<SHA>  # vX.Y.Z
    with:
      docker_image: ghcr.io/my-org/my-image:latest
      # ... other inputs
```

### 2. A `.standard.yml` file in the repo root

This is what the compliance workflow looks for. It records which tag/SHA the repo is pinned to:

```yaml
# Generated by standard-ci — do not edit manually

version: 0.17.0
preset: full
tag: vX.Y.Z
sha: <full-40-char-sha>
workflows:
  - cpp-quality
  - infra-lint
  - python-quality
```

#### Quick onboard with CLI

```bash
cd /path/to/consumer-repo
pip install standard-ci   # or: pip install git+https://github.com/PavelGuzenfeld/standard.git
standard-ci init --preset recommended
# Creates .github/workflows/*.yml + .standard.yml
git add . && git commit -m "chore: onboard standard-ci" && git push
```

#### Manual onboard (existing workflow)

If the repo already has workflow files calling standard workflows, just add `.standard.yml`:

```yaml
tag: vX.Y.Z
sha: <full-40-char-sha>
workflows:
  - cpp-quality
  - infra-lint
```

## Operations

### Where is the dashboard?

**Option A: GitHub Actions → workflow run summary**

Go to the Actions tab of the org's `.github` repo and click the latest "Compliance" run:
`https://github.com/my-org/.github/actions/workflows/compliance.yml`

The dashboard is in the **Summary** tab (step summary).

**Option B: Download artifact**

Each run uploads a `compliance-dashboard` artifact (markdown file).

**Option C: Run locally**

```bash
export GITHUB_TOKEN=ghp_...
standard-ci dashboard --org my-org
standard-ci dashboard --org my-org --format json
```

### How to trigger manually

Each org's workflow is triggered from that org's `.github` repo, not from `standard`.

**From GitHub UI:**

1. Go to `https://github.com/my-org/.github/actions/workflows/compliance.yml`
2. Click **"Run workflow"** (top right)
3. Check "auto_update" to also open PRs in drifted repos
4. Check "dry_run" to preview without opening PRs
5. Click **"Run workflow"**

**From CLI:**

```bash
# Dashboard only (default)
gh workflow run compliance.yml --repo my-org/.github

# Dashboard + open update PRs
gh workflow run compliance.yml --repo my-org/.github \
  -f auto_update=true

# Dashboard + dry run (preview PRs)
gh workflow run compliance.yml --repo my-org/.github \
  -f auto_update=true -f dry_run=true
```

### Scan without opening PRs (CLI only)

```bash
export GITHUB_TOKEN=ghp_...

# Quick scan — see which repos are current/drifted/unconfigured
standard-ci scan --org my-org

# JSON output (for scripting)
standard-ci scan --org my-org --json

# Exit non-zero if any repo is drifted (useful in CI)
standard-ci scan --org my-org --exit-code
```

### Auto-update PRs (CLI only)

```bash
export GITHUB_TOKEN=ghp_...

# Dry run — see what PRs would be opened
standard-ci auto-update --org my-org --dry-run

# Actually open PRs
standard-ci auto-update --org my-org
```

## What happens automatically

| Event | Action |
|-------|--------|
| Every Monday 9am UTC | Compliance workflow runs per org — dashboard generated (visible in that org's `.github` Actions summary) |
| PR opened by bot in consumer repo | Team reviews and merges the SHA pin update |

To also auto-update on schedule, set `auto_update: true` in the trigger workflow's `with:` block.

## Troubleshooting

| Problem | Solution |
|---------|----------|
| Bot can't push to consumer repo | Check `COMPLIANCE_BOT_TOKEN` in the org's `.github` repo has `repo` + `workflow` scopes |
| Bot doesn't detect a repo | Add `.standard.yml` to the repo root |
| Dashboard shows "0 repos scanned" | Token may lack `read:org` scope for private orgs |
| PR has merge conflicts | The bot creates a simple branch; resolve conflicts and merge manually |
| Want to skip a repo | Don't add `.standard.yml` — unconfigured repos are listed but not updated |
| Workflow fails at "Install standard-ci" | Reusable workflow needs `repository: PavelGuzenfeld/standard` in checkout step |

## CIS Supply Chain Compliance

### What It Is

[CIS Software Supply Chain Security v1.0](https://www.cisecurity.org/benchmark/software-supply-chain-security)
is a benchmark that evaluates GitHub repository and organization security posture:
branch protection, signed commits, CI pipeline security, dependency management, etc.

The scan uses [chain-bench](https://github.com/aquasecurity/chain-bench) by Aqua Security
to check 35 controls across 5 categories.

### Why Org-Level?

Per-repo CIS scans score **0/35** because `GITHUB_TOKEN` in a `workflow_call` context
lacks permissions to read org-level settings (2FA enforcement, team-based reviews, RBAC).
Moving the scan to the org's `.github` repo with an App token solves this.

### Architecture

```
PavelGuzenfeld/standard (source of truth)
  └── .github/workflows/
        └── cis-org-compliance.yml  ← reusable workflow (the engine)

Each org's .github repo (trigger)
  └── .github/workflows/
        └── cis-compliance.yml  ← calls standard's reusable workflow
```

Every run: discover repos → scan each with chain-bench → aggregate dashboard.

### Setup (One-Time per Org)

#### 1. Create or configure a GitHub App

The App needs these permissions:
- **Organization: Members** (read) — 2FA enforcement checks
- **Repository: Administration** (read) — branch protection rules
- **Repository: Contents** (read) — repo contents
- **Repository: Actions** (read) — workflow inspection
- **Repository: Issues** (read & write) — tracking issue (optional)

Install the App on the org and note the **App ID** and **Private Key**.

#### 2. Set secrets in the org's `.github` repo

```bash
gh secret set CIS_APP_ID --repo my-org/.github --body "12345"
gh secret set CIS_APP_PRIVATE_KEY --repo my-org/.github < app-private-key.pem
```

Or reuse existing App secrets if the same App has adequate permissions.

#### 3. Add trigger workflow to the org's `.github` repo

Create `.github/workflows/cis-compliance.yml`:

```yaml
name: CIS Compliance

on:
  schedule:
    - cron: '0 10 * * 6'  # Saturday 10am UTC
  workflow_dispatch:
    inputs:
      repos:
        description: 'Specific repos to scan (comma-separated, empty=all)'
        type: string
        default: ''

permissions:
  contents: read

jobs:
  cis:
    uses: PavelGuzenfeld/standard/.github/workflows/cis-org-compliance.yml@main
    with:
      org: my-org
      repos: ${{ inputs.repos || '' }}
      create_tracking_issue: true
    secrets:
      app_id: ${{ secrets.CIS_APP_ID }}
      app_private_key: ${{ secrets.CIS_APP_PRIVATE_KEY }}
```

### How It Works

1. **Discovers repos** — lists all non-archived repos with `.standard.yml` (or uses explicit `repos` input)
2. **Scans each repo** with chain-bench using the App token
3. **Generates a dashboard** — markdown table with per-repo scores posted to workflow summary
4. **Creates/updates a tracking issue** (optional) in the `.github` repo
5. **Fails if below threshold** — when `min_score > 0`, exits non-zero if any repo scores below

### Trigger Manually

```bash
# Scan all repos
gh workflow run cis-compliance.yml --repo my-org/.github

# Scan specific repos
gh workflow run cis-compliance.yml --repo my-org/.github \
  -f repos="repo-a,repo-b"
```

### Dashboard Output

Each run produces a table like:

| Repo | Passed | Failed | Unknown | Score | Status |
|:-----|:------:|:------:|:-------:|:-----:|:------:|
| rocx | 22 | 10 | 3 | 63% | PASS |
| standard | 25 | 8 | 2 | 71% | PASS |

Results are available in:
- **Workflow run summary** (Actions tab of `.github` repo)
- **Tracking issue** (if `create_tracking_issue: true`)
- **Artifact download** (`cis-org-compliance` artifact)

### Per-Repo CIS (Optional)

The per-repo `cis-compliance.yml` workflow still exists for repos that want
a detailed single-repo CIS report on PRs. Set `min_score: 0` (report-only)
unless the repo has an App token with org-level read access.

### Inputs Reference

| Input | Default | Description |
|-------|---------|-------------|
| `org` | (required) | GitHub org or user to scan |
| `repos` | `""` | Comma-separated repo names (empty = auto-discover) |
| `max_repos` | `20` | Max repos to scan per run |
| `min_score` | `0` | Minimum CIS score (0 = report only) |
| `chain_bench_version` | `0.1.10` | chain-bench release version |
| `create_tracking_issue` | `false` | Post results to a tracking issue |

### Secrets Reference

| Secret | Required | Description |
|--------|----------|-------------|
| `app_id` | No | GitHub App ID with org-level read permissions |
| `app_private_key` | No | GitHub App private key (PEM) |
| `scan_token` | No | PAT with `repo` + `read:org` scope (fallback) |

## CLI Reference

```
standard-ci scan --org ORG [--token TOKEN] [--json] [--exit-code]
standard-ci dashboard --org ORG [--token TOKEN] [--format markdown|json] [--scan-results FILE]
standard-ci auto-update --org ORG [--token TOKEN] [--dry-run] [--scan-results FILE]
                        [--pr-title-prefix PREFIX] [--pr-labels LABELS]
```
