name: Python SAST

on:
  workflow_call:
    inputs:
      python_version:
        type: string
        default: '3.12'
        description: 'Python version to use'
      enable_semgrep:
        type: boolean
        default: true
        description: 'Enable Semgrep security scanning'
      semgrep_version:
        type: string
        default: '1.150.0'
        description: 'Semgrep Docker image version (pin to avoid breaking changes)'
      semgrep_rules:
        type: string
        default: 'p/python p/owasp-top-ten'
        description: 'Semgrep rule sets (space-separated)'
      enable_pip_audit:
        type: boolean
        default: true
        description: 'Enable pip-audit dependency CVE scanning'
      requirements_file:
        type: string
        default: 'requirements.txt'
        description: 'Path to requirements file for pip-audit'
      enable_codeql:
        type: boolean
        default: false
        description: 'Enable CodeQL deep analysis (free for public repos)'
      codeql_queries:
        type: string
        default: 'security-extended'
        description: 'CodeQL query suite: security-extended (recommended) or security-and-quality'
      runner:
        type: string
        default: '"ubuntu-latest"'
        description: 'Runner labels as JSON (e.g., "\"ubuntu-latest\"" or "[\"self-hosted\",\"X64\",\"Linux\"]")'

permissions:
  actions: read
  contents: read
  pull-requests: write
  security-events: write

jobs:
  semgrep:
    name: Semgrep
    if: inputs.enable_semgrep
    runs-on: ${{ fromJSON(inputs.runner) }}
    container:
      image: semgrep/semgrep:${{ inputs.semgrep_version }}
    steps:
      - name: Check out repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Run Semgrep
        run: semgrep scan --config ${{ inputs.semgrep_rules }} --sarif --output=semgrep.sarif --error
        continue-on-error: true
        id: semgrep-scan

      - name: Upload SARIF
        if: always() && steps.semgrep-scan.outcome != 'skipped'
        uses: github/codeql-action/upload-sarif@bb471cdcf4dda2c934c5b656f554d43c1434ed13 # v4
        with:
          sarif_file: semgrep.sarif
          category: semgrep
        continue-on-error: true

  pip-audit:
    name: pip-audit
    if: inputs.enable_pip_audit
    runs-on: ${{ fromJSON(inputs.runner) }}
    steps:
      - name: Check out repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python ${{ inputs.python_version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f "${{ inputs.requirements_file }}" ]; then
            pip install -r "${{ inputs.requirements_file }}"
          fi

      - name: Run pip-audit
        id: audit
        uses: pypa/gh-action-pip-audit@1220774d901786e6f652ae159f7b6bc8fea6d266 # v1.1.0
        continue-on-error: true

  codeql:
    name: CodeQL
    if: inputs.enable_codeql
    runs-on: ${{ fromJSON(inputs.runner) }}
    steps:
      - name: Check out repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@bb471cdcf4dda2c934c5b656f554d43c1434ed13 # v4
        with:
          languages: python
          queries: ${{ inputs.codeql_queries }}

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@bb471cdcf4dda2c934c5b656f554d43c1434ed13 # v4
        with:
          category: python-sast

  summary:
    name: SAST Summary
    runs-on: ${{ fromJSON(inputs.runner) }}
    needs: [semgrep, pip-audit, codeql]
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Post or update PR comment
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const marker = '<!-- python-sast-report -->';
            const semgrep = '${{ needs.semgrep.result }}';
            const audit = '${{ needs.pip-audit.result }}';
            const codeql = '${{ needs.codeql.result }}';

            const icon = (r) => {
              if (r === 'success') return '✅';
              if (r === 'skipped') return '⏭️';
              if (r === 'failure') return '❌';
              return '⚠️';
            };

            let body = marker + '\n## Python SAST Scoreboard\n\n';
            body += '| Check | Result |\n|:------|:------:|\n';

            if (semgrep && semgrep !== 'skipped') {
              body += `| Semgrep | ${icon(semgrep)} ${semgrep === 'success' ? 'no findings' : 'findings reported'} |\n`;
            }
            if (audit && audit !== 'skipped') {
              body += `| pip-audit | ${icon(audit)} ${audit === 'success' ? 'no known CVEs' : 'vulnerabilities found'} |\n`;
            }
            if (codeql && codeql !== 'skipped') {
              body += `| CodeQL | ${icon(codeql)} ${codeql === 'success' ? 'no findings' : 'findings reported'} |\n`;
            }

            body += '\n---\n<sub>Powered by <a href="https://github.com/PavelGuzenfeld/standard">standard</a> · See the Security tab for detailed SARIF results</sub>';

            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const existing = comments.find(c => c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body,
              });
            }
