name: Pull Request Feedback

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  quality-checks:
    name: Diff-Aware Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Check out full repository history
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run diff-aware linting with ruff
        id: ruff-diff
        run: |
          diff-quality --violations=ruff.check \
            --compare-branch=origin/${{ github.base_ref }} \
            --fail-under=100
        continue-on-error: true

      - name: Run tests and collect coverage
        run: |
          pytest --cov --cov-report=xml --verbose

      - name: Generate diff coverage report
        id: diff-cover
        run: |
          echo "DIFF_COVER_REPORT<<EOF" >> $GITHUB_ENV
          diff-cover coverage.xml \
            --compare-branch=origin/${{ github.base_ref }} \
            --markdown-report=diff-cover.md || true
          cat diff-cover.md >> $GITHUB_ENV 2>/dev/null || \
            diff-cover coverage.xml \
              --compare-branch=origin/${{ github.base_ref }} >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        continue-on-error: true

      - name: Post or update quality report as PR comment
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        if: steps.ruff-diff.outcome == 'failure' || failure()
        with:
          script: |
            const marker = '<!-- quality-report -->';
            const output = process.env.DIFF_COVER_REPORT || 'No coverage data available';
            const ruffResult = '${{ steps.ruff-diff.outcome }}';

            let body = marker + '\n## Diff Quality Report\n\n';

            // Lint status
            if (ruffResult === 'failure') {
              body += '**Lint**: ruff found issues in changed lines\n\n';
            } else {
              body += '**Lint**: clean\n\n';
            }

            // Coverage
            if (output.includes('No coverage data available')) {
              body += 'No coverage data was generated for this PR.\n';
            } else {
              body += output;
            }

            body += '\n\n---\n*This report shows quality metrics only for lines changed in this PR.*';

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const existing = comments.find(c => c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body,
              });
            }

      - name: Check ruff status
        if: steps.ruff-diff.outcome == 'failure'
        run: |
          echo "Ruff found linting issues in your changes"
          exit 1
