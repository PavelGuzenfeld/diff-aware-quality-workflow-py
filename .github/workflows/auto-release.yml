name: Auto Release

on:
  workflow_call:
    inputs:
      default_bump:
        type: string
        default: 'patch'
        description: 'Default bump when no conventional commit prefix detected'
      enable_provenance:
        type: boolean
        default: false
        description: 'Enable SLSA provenance attestation for releases (opt-in)'

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  release:
    name: Tag & Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Determine version bump
        id: bump
        run: |
          # Find latest semver tag
          LAST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -1)
          FIRST_RELEASE=false
          if [ -z "$LAST_TAG" ]; then
            FIRST_RELEASE=true
            echo "No existing tags found â€” first release will be v0.0.1"
          else
            echo "Latest tag: $LAST_TAG"
          fi
          echo "last_tag=$LAST_TAG" >> "$GITHUB_OUTPUT"
          echo "first_release=$FIRST_RELEASE" >> "$GITHUB_OUTPUT"

          # Get commits since last tag
          if [ "$FIRST_RELEASE" = "true" ]; then
            COMMITS=$(git log --oneline)
          else
            COMMITS=$(git log "$LAST_TAG"..HEAD --oneline)
          fi

          if [ -z "$COMMITS" ]; then
            echo "No new commits since $LAST_TAG"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Commits since ${LAST_TAG:-beginning}:"
          echo "$COMMITS"

          # Determine bump level from commit messages
          BUMP="${{ inputs.default_bump }}"

          if echo "$COMMITS" | grep -qiE 'BREAKING CHANGE:|^[a-f0-9]+ (feat|fix|refactor|chore|docs|style|perf|test|build|ci)(\(.+\))?!:'; then
            BUMP="major"
          elif echo "$COMMITS" | grep -qiE '^[a-f0-9]+ feat(\(.+\))?:'; then
            BUMP="minor"
          fi

          echo "Bump level: $BUMP"
          echo "bump=$BUMP" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Calculate next version
        if: steps.bump.outputs.skip != 'true'
        id: version
        run: |
          FIRST_RELEASE="${{ steps.bump.outputs.first_release }}"

          # Per versioning rules: first release is always v0.0.1
          if [ "$FIRST_RELEASE" = "true" ]; then
            NEXT="v0.0.1"
            echo "First release: $NEXT"
            echo "next=$NEXT" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          LAST_TAG="${{ steps.bump.outputs.last_tag }}"
          BUMP="${{ steps.bump.outputs.bump }}"

          # Strip v prefix and split
          VER="${LAST_TAG#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VER"

          case "$BUMP" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEXT="v${MAJOR}.${MINOR}.${PATCH}"
          echo "Next version: $NEXT"
          echo "next=$NEXT" >> "$GITHUB_OUTPUT"

      - name: Create and push tag
        if: steps.bump.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          NEXT="${{ steps.version.outputs.next }}"
          git tag -a "$NEXT" -m "Release $NEXT"
          git push origin "$NEXT"

      - name: Create GitHub Release
        if: steps.bump.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NEXT="${{ steps.version.outputs.next }}"
          gh release create "$NEXT" --generate-notes --title "$NEXT"

      - name: Compute release tarball digest
        if: steps.bump.outputs.skip != 'true' && inputs.enable_provenance
        id: digest
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NEXT="${{ steps.version.outputs.next }}"
          gh release download "$NEXT" --archive=tar.gz --output /tmp/release.tar.gz
          SHA256=$(sha256sum /tmp/release.tar.gz | awk '{print $1}')
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"
          echo "Tarball SHA-256: $SHA256"

      - name: Attest release provenance
        if: steps.bump.outputs.skip != 'true' && inputs.enable_provenance
        uses: actions/attest-build-provenance@43d14bc2b83dec42d39ecae14e916627a18bb661 # v3
        with:
          subject-name: ${{ github.repository }}-source-${{ steps.version.outputs.next }}.tar.gz
          subject-digest: sha256:${{ steps.digest.outputs.sha256 }}
