name: Compliance Bot

on:
  workflow_call:
    inputs:
      org:
        type: string
        required: true
        description: 'GitHub org or user to scan'
      dry_run:
        type: boolean
        default: false
        description: 'Show what would change without opening PRs'
      pr_title_prefix:
        type: string
        default: 'chore(deps): '
        description: 'Prefix for auto-update PR titles'
      pr_labels:
        type: string
        default: 'dependencies,standard-ci'
        description: 'Comma-separated labels for auto-update PRs'
      runner:
        type: string
        default: '"ubuntu-latest"'
        description: 'Runner labels as JSON'
    secrets:
      bot_token:
        required: false
        description: 'GitHub token with repo write access to consumer repos'
      app_id:
        required: false
        description: 'GitHub App ID for generating installation token'
      app_private_key:
        required: false
        description: 'GitHub App private key (PEM)'

permissions:
  contents: read

jobs:
  scan-and-update:
    name: Scan & Open Update PRs
    runs-on: ${{ fromJSON(inputs.runner) }}
    steps:
      - name: Checkout standard
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install standard-ci
        run: pip install .

      - name: Generate App token
        id: app-token
        if: inputs.org != '' && secrets.app_id != ''
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.app_id }}
          private-key: ${{ secrets.app_private_key }}
          owner: ${{ inputs.org }}

      - name: Scan org for compliance
        id: scan
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token || secrets.bot_token }}
        run: |
          standard-ci scan --org "${{ inputs.org }}" --json \
            > "${{ runner.temp }}/scan-results.json"
          standard-ci dashboard --org "${{ inputs.org }}" \
            --scan-results "${{ runner.temp }}/scan-results.json" \
            >> $GITHUB_STEP_SUMMARY

      - name: Open update PRs
        if: inputs.dry_run == false
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token || secrets.bot_token }}
        run: |
          standard-ci auto-update \
            --org "${{ inputs.org }}" \
            --scan-results "${{ runner.temp }}/scan-results.json" \
            --pr-title-prefix "${{ inputs.pr_title_prefix }}" \
            --pr-labels "${{ inputs.pr_labels }}"

      - name: Dry run report
        if: inputs.dry_run == true
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token || secrets.bot_token }}
        run: |
          standard-ci auto-update \
            --org "${{ inputs.org }}" \
            --scan-results "${{ runner.temp }}/scan-results.json" \
            --dry-run
